<!DOCTYPE html>
<html lang="en">
	<head>
		<title>car</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;
			}
			#info a, .button { height:50px;width:80px;color: #f00; font-weight: bold; text-decoration: none; cursor: pointer }
		</style>
		
	</head>

	<body>
		<script src="../build/three.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script src="js/MTLLoader.js"></script>
		<script src="js/BinaryLoader.js"></script>
		<script src="js/OrbitControls.js"></script>
		<script src="js/libs/jszip.min.js"></script>
		<script src="js/libs/jszip-utils.min.js"></script>
		
		
		<script>

			var container;

			var camera,  controls, scene, renderer;
			
				
			var mouseX = 0, mouseY = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			var directionalLight;
			
			

			var _config;
			
			
			init();
			animate();
			
			function initCamera(){
				
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
				camera.position.set(0,300,740);
				
				//cameraFront = cameraBack = camera.clone();
			
			}
			function initScene(){
				
				scene = new THREE.Scene();
				
				
				initLight(scene);
			}
			function initLight(_scene){
			
				var ambient = new THREE.AmbientLight( 0x222222 );
				_scene.add( ambient );

				//directionalLight = new THREE.DirectionalLight( 0xffffff );
				//directionalLight.position.set( 0, 0, 1 ).normalize();
				//_scene.add( directionalLight );

				
				this.addPointLight = function(_x,_y,_z){
					var _light = new THREE.PointLight(0x888888,0.7);
					//var _light = new THREE.PointLight(0xffffff,1.0);
					_light.position.set(_x,_y,_z);
					_scene.add(_light)
				}
				
				// addPointLight(0,-400,0);
				 addPointLight(0,400,0);
				// addPointLight(0,0,400);
				// addPointLight(0,0,-400);

				var heimLight = new THREE.HemisphereLight(0xffffff,0x888888,1.0);
				_scene.add(heimLight);
				
			}
			function initControl(_camera){
				
				var _controls = new THREE.OrbitControls( _camera, renderer.domElement );
				//controls.addEventListener( 'change', render ); // add this only if there is no animation loop (requestAnimationFrame)
				_controls.enableDamping = true;
				_controls.dampingFactor = 0.25;
				_controls.target.set(0, 50, 0);
				_controls.minDistance = 350;
				_controls.maxDistance = 750;
				//_controls.autoRotate = true;
				_controls.enablePan = false;
				_controls.enabledAutoRotatePhi = true;
				_controls.autoRotateSpeed = 2.2;
				_controls.phiRotationSpeed = 2.2;
				_controls.minPolarAngle = THREE.Math.degToRad(70);
				_controls.maxPolarAngle = THREE.Math.degToRad(89);
				_controls.update();
				
				return _controls;

			}

			function loadRefTexture(loader,url){

				var maxAnisotropy = renderer.getMaxAnisotropy();

				var _tex = loader.load(url );
				_tex.anisotropy = maxAnisotropy;

				_tex.mapping = THREE.SphericalReflectionMapping;

				return _tex;
			}
		
			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				renderer = new THREE.WebGLRenderer({antialias:true});
				renderer.setPixelRatio( window.devicePixelRatio );
				//renderer.setClearColor('#888888');
				renderer.setSize( window.innerWidth, window.innerHeight );
				//renderer.shadowMap.enabled = true;
				// renderer.gammaInput = true;
				// renderer.gammaOutput = true;
			//	renderer.physicallyCorrectLights = true;
			//	renderer.gammaFactor = 1.5;
				renderer.toneMapping = THREE.CineonToneMapping;
			 	renderer.toneMappingExposure = Math.pow( 1.1, 4.0 );
				container.appendChild( renderer.domElement );

				initCamera();
				
				initScene();
			
				var path = "obj/road/";
				var format = '.jpg';
				var urls = [
						path + 'px' + format, path + 'nx' + format,
						path + 'py' + format, path + 'ny' + format,
						path + 'pz' + format, path + 'nz' + format
					];

				var reflectionCube = new THREE.CubeTextureLoader().load( urls );
				reflectionCube.format = THREE.RGBFormat;

			//	var materialBkg = new THREE.ShaderMaterial( {

				// 	uniforms: {"tCube": reflectionCube},
				// 	vertexShader: 'varying vec2 outUV;void main(){outUV=uv;vec4 mvPosition = modelViewMatrix*vec4(position,1.0 );gl_Position = projectionMatrix * mvPosition;}',
				// 	fragmentShader:'uniform samplerCube tCube;varying vec2 outUV;vec4 cubeToLatLon(samplerCube cubemap, vec2 inUV){const float PI = 3.141592653589793238462643383;vec3 cubmapTexCoords;cubmapTexCoords.x = -cos(inUV.x * PI * 2.0) * sin(inUV.y * PI);cubmapTexCoords.y = -cos(inUV.y * PI);cubmapTexCoords.z = -sin(inUV.x * PI * 2.0) * sin(inUV.y * PI);return textureCube(cubemap, cubmapTexCoords);}void main( void ){gl_FragColor = cubeToLatLon(tCube, outUV);}'

				// } );

				var textureLoader = new THREE.TextureLoader();
				var envMap = loadRefTexture(textureLoader,path+'envMap.jpg');

				

				 var materialBkg = new THREE.MeshPhongMaterial({map:envMap});
				var loaderEnv = new THREE.BinaryLoader()
				 .load(path+"/environment.js",function(geometry){
					
					var meshBkg = new THREE.Mesh(geometry,materialBkg);//new THREE.MeshBasicMaterial({map:tex,depthWrite:false})
					scene.add(meshBkg);
				});


		

				//scene.background = reflectionCube;
				
				

				controls = initControl(camera);
				
				var srcUrl = 'obj/';

		//		var groundMap = new THREE.TextureLoader().load(srcUrl+"ground.png");
			//	var groundAlpahMap = new THREE.TextureLoader().load(srcUrl+"untitle.png");
				
				
				var bodyMap = new THREE.TextureLoader().load(srcUrl+"GTR_body1.png");
				var bodyReflMap = new THREE.TextureLoader().load(srcUrl+"92581108.png");
				bodyReflMap.mapping = THREE.SphericalReflectionMapping;
				
				var insideMap = new THREE.TextureLoader().load(srcUrl+"GTR_inside1.png");
				var insideBumpMap = new THREE.TextureLoader().load(srcUrl+"Map__91.png");
			
				var wheelMap = new THREE.TextureLoader().load(srcUrl+"GTR_wheel.png");
				var wheelBumpMap = new THREE.TextureLoader().load(srcUrl+"Map__86.png");
				var wheelSpecMap = new THREE.TextureLoader().load(srcUrl+"GTR_wheel_s.png");

				var outMap = new THREE.TextureLoader().load(srcUrl+"gtr_02_01.png");
			


				var white = new THREE.MeshPhongMaterial({color:0xaaaaaa,specular:0xbbbbbb,shininess: 20});
				var black = new THREE.MeshPhongMaterial({color:0x333333,specular:0x666666,shininess: 20});
				var metal = new THREE.MeshPhongMaterial({color: 0xaaaaaa,specular:0x666666,shininess: 20,envMap: reflectionCube,reflectivity: 1.0});
			//	var basic = new THREE.MeshPhongMaterial({color: 0xaaaaaa,specular:0x666666,shininess: 20,map:groundMap, alphaMap:groundAlpahMap});
				var glass = new THREE.MeshBasicMaterial( { color: 0x223344, envMap: reflectionCube, opacity: 0.25, transparent: true, combine: THREE.MixOperation, reflectivity: 0.25 } );
				var neishi = new THREE.MeshBasicMaterial({color: 0xaaaaaa,map: insideMap});//,bumpMap: insideBumpMap,bumpScale:1.11
				var wheel = new THREE.MeshPhongMaterial({color: 0xaaaaaa,specularMap:wheelSpecMap,shininess: 20,map:wheelMap,bumpMap: wheelBumpMap,bumpScale:1.11,envMap: reflectionCube,reflectivity: 0.8});
				var wheelChepai = new THREE.MeshPhongMaterial({color: 0xaaaaaa,specular:0x666666,shininess: 20,map:wheelMap,envMap: reflectionCube,reflectivity: 0.05, combine: THREE.MixOperation});

				var out =  new THREE.MeshPhongMaterial({color: 0xaaaaaa,specular:0x666666,shininess: 20,map: outMap});

				//var body = new THREE.MeshStandardMaterial({color: 0xaaaaaa,map:bodyMap,roughness:0.7,metalness:0.7,envMap:bodyReflMap,reflectivity:1.0});
				var body = new THREE.MeshStandardMaterial({color: 0xaaaaaa,map:bodyMap,roughness:0.4,metalness:0.9,envMap:reflectionCube,envMapIntensity:0.5});
				var body1 = new THREE.MeshStandardMaterial({color: 0xaaaaaa,map: bodyMap});
				// model

				 _config = {
					//'_1baked_Material__692' : new THREE.MeshPhongMaterial({color: 0xaaaaaa,specular:0x666666,shininess:20,map:groundMap, alphaMap:groundAlpahMap}),
					'_1gtr_02_01' :           out,
					'_1gtr_04_01ss' :         glass,
					'_1orig_Material__661' :  neishi,
					'_101___Default' :        metal,
					'_104___Default' :        black,
					'_104___Defaultssss' :    black,
					'_112___Default' :        black,
					'_117___Default' : 		  body,
					'_117___Default22' :      body1,//body1
					'_117___Defaultww' :      out,
					'_1Material__545' :       wheel,
					'_1Material__689' :       wheel,
					'_1Material__516' :       wheelChepai,
					'boli' :      			  glass,
					'neishi' :                neishi

					

				};
				

				loadZip('obj/','youhua',_config);
				
				
			
				
				

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				window.addEventListener( 'resize', onWindowResize, false );

			}

			function loadObj(srcUrl,name,text){
				var mtlLoader = new THREE.MTLLoader();
				var objLoader = new THREE.OBJLoader();
				
				mtlLoader.setPath( srcUrl );
				objLoader.setPath( srcUrl);
				mtlLoader.load( name + '.mtl', function( materials ) {

					materials.preload();
					objLoader.setMaterials( materials );
					console.log(materials);

					for (var name in _config){
						materials.materials[name] = _config[name];
						//materials[name].name += '0';
						//materials[name].needUpdate = true;
						//console.log(materials[name]);
					}

					var object = objLoader.parse(text);

					// objLoader.load( name + '.obj', function ( object ) {
						
					
						object.rotateY(-Math.PI/2);
						object.scale.set(20,20,20);
						object.position.set(0,0,-120);
						scene.add(object);

					// } );

				});
			}

			function loadZip(url,name){

				JSZipUtils.getBinaryContent(url+name+'.zip', function(err, data) {
				    if(err) {
				        throw err; // or handle err
				    }
				    var zip = new JSZip(data);

				    var str = zip.file(name + '.obj').asText();
				           
				    loadObj(url,name,str);
				});
			}
		
			function animate() {

				controls.update();
			
				requestAnimationFrame( animate );
				render();
			
			}

			function render() {

				//directionalLight.position.copy(camera.position);
				//console.log(camera.position);
				//renderer.setClearColor('#000000');
		    	//renderer.clearTarget(rtBack, true, true);
				renderer.render(scene ,camera);
			
	
			}
			
			

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function onDocumentMouseMove( event ) {

				mouseX = ( event.clientX - windowHalfX ) / 2;
				mouseY = ( event.clientY - windowHalfY ) / 2;

			}

			//

		

		

		</script>

	</body>
</html>
